---
title: "Pathway enrichment analysis (all LV samples vs all PV samples)"
author:
  - "trnguyen@ukaachen.de"
date: "Last update on `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: true
    toc_float:
      toc_collapsed: false
    toc_depth: 5
    theme: lumen
---

  
```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
$(document).ready(function() {
  $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
  // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```


In this analysis, we perform the Gene Set Enrichment Analysis (GSEA) for the Differentially expressed (DE) genes found from the analysis of LV20, 21 and PV20, 21 samples. 


```{r echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.width=20, fig.height=12}
##### Preparation
gc()
rm(list = ls())

set.seed(42)

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

source("00_import_libraries.R")
source("00_helper_functions.R")

path.to.main.input <- "/media/hieunguyen/CRC1382H/CRC1382/outdir/AGBerres/220311_Berres_MiedIII_scCITEseq"

path.to.main.output <- file.path(path.to.main.input, "data_analysis")
dir.create(path.to.main.output, showWarnings = FALSE)

path.to.01.output <- file.path(path.to.main.output, "01_output")
dir.create(path.to.01.output, showWarnings = FALSE)

s.obj <- readRDS(file.path(path.to.01.output, "s_obj.annotated.integrated.tsne.rds"))

# BiocManager::install("clusterProfiler")
library("clusterProfiler")
library("org.Hs.eg.db")

compare_DC1_DC2_raw <- readRDS(file.path(path.to.01.output, "DE_markers_DC1_vs_DC2_all_cases_raw.tsne.rds"))

path.to.02.output <- file.path(path.to.main.output, "02_output", "DC1_vs_DC2")
dir.create(path.to.02.output, showWarnings = FALSE)

dir.create(file.path(path.to.02.output, "enrichment_plots"), showWarnings = FALSE)
```


```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
print(sprintf("we consider the DE analysis between DC1 and DC2 in the following cases: %s", paste(names(compare_DC1_DC2_raw), collapse = ", ")))
```

# Notes

## Differential gene expression analysis

The differential gene expression analysis was conducted for comparing DC1 cells versus DC2 cells. 

- **Positive** `avg_log2FC` indicates that the gene is up-regulated in DC1. 
- **Negative** `avg_log2FC` indicates that the gene is up-regulated in DC2. 

## Over-representation analysis (ORA)

- `ONTOLOGY`: BP, MF, and CC represent Biological Process, Molecular Function, and Cellular Component groups of GO. In this analysis, we use all these three subontologies.

- There are two p-values calculuated by the ORA: `pvalue` and `p.adjust`, we will use only the `p.adjust` and `q.value` to decide if a pathway is enriched or not. Method of False discovery rate: Benjamin - Hochberg. Thresholds are: `p.value <= 0.05` and `p.adjust <= 0.05` and `q.value <= 0.05`. 

- Explanation on the output of ORA summary table:

  - `GeneRatio`: `GeneRatio = k/n`, where `k` is the number of genes within your input gene list (genes of interest) which are annotated to the gene set and `n` is the size of the list of genes of interest. 
  
  - `BgRatio`: `BgRatio = M/N`, where `M` is the number of genes within the hypergeometric distribution (the distribution we used to calculate the p-value) that are annotated (either directly or indirectly) to the genes of interest. `N` is the total number of genes in the background distribution (by default, it is all the genes that have annotation). 
  

- In the ORA, our gene set of interest is the **significantly differentially expressed genes** found from previous analysis. 

## Gene set enrichment analysis (GSEA)

- All genes will be used in the GSEA. Genes are ranked based on their average log2 Fold-change, which was found from the DE analysis. 

- GSEA aggregates the per gene statistics across genes within a gene set, therefore making it possible to detect situations where all genes in a predefined set change in a small but coordinated way.

- Given apriori defined set of gene S, the goal of GSEA is to determine whether the members of S are randomly distributed throughout the ranked gene list (L) or primarily found at the top or bottom.

- There are three key elements of the GSEA method:

  - Calculation of an Enrichment Score.
  
  - Estimation of Significance Level of ES.
  
  - Adjustment for Multiple Hypothesis Testing.

For all significant pathways, we generate a bar-plot showing all Normalized Enrichment Scores.


**CLICK ON THE IMAGE TO ZOOM-IN AND ONE MORE CLICK TO GO BACK TO THE ORIGINAL**

**If the table is empty, that means; no significant pathways were found**

**Updated note:**

`set.seed(42)` and set `seed = TRUE` in the functions of `clusterProfiler` to ensure reproducibility. 


# Lists of all genes

## Full list of genes ranked by `avg_log2FC` {.tabset}

### All LV and all PV samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare_DC1_DC2_raw[["all_LV_and_all_PV"]] %>% arrange(desc(avg_log2FC)) %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

### All LV samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare_DC1_DC2_raw[["all_LV_samples"]] %>% arrange(desc(avg_log2FC)) %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

### All PV samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare_DC1_DC2_raw[["all_PV_samples"]] %>% arrange(desc(avg_log2FC)) %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

### LV20
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare_DC1_DC2_raw[["LV20"]] %>% arrange(desc(avg_log2FC)) %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

### LV21
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare_DC1_DC2_raw[["LV21"]] %>% arrange(desc(avg_log2FC)) %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

### PV20
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare_DC1_DC2_raw[["PV20"]] %>% arrange(desc(avg_log2FC)) %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

### PV21
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare_DC1_DC2_raw[["PV21"]] %>% arrange(desc(avg_log2FC)) %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```


## Gene of interest {.tabset}

### All LV and all PV samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare_DC1_DC2_raw[["all_LV_and_all_PV"]] %>% subset(p_val_adj <= 0.05) %>% arrange(desc(avg_log2FC)) %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

### All LV samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare_DC1_DC2_raw[["all_LV_samples"]] %>% subset(p_val_adj <= 0.05) %>% arrange(desc(avg_log2FC)) %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

### All PV samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare_DC1_DC2_raw[["all_PV_samples"]] %>% subset(p_val_adj <= 0.05) %>% arrange(desc(avg_log2FC)) %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

### LV20
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare_DC1_DC2_raw[["LV20"]] %>% subset(p_val_adj <= 0.05) %>% arrange(desc(avg_log2FC)) %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

### LV21
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare_DC1_DC2_raw[["LV21"]] %>% subset(p_val_adj <= 0.05) %>% arrange(desc(avg_log2FC)) %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

### PV20
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare_DC1_DC2_raw[["PV20"]] %>% subset(p_val_adj <= 0.05) %>% arrange(desc(avg_log2FC)) %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

### PV21
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare_DC1_DC2_raw[["PV21"]] %>% subset(p_val_adj <= 0.05) %>% arrange(desc(avg_log2FC)) %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

# Main analysis

                  ## GO-ORA 

### Summary tables {.tabset}

#### All LV and all PV samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "all_LV_and_all_PV"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]]
input.gene.list <- subset(tmp.full.list, tmp.full.list$p_val_adj <= 0.05)$Gene

if (length(input.gene.list != 0)){
  ora.GO <- enrichGO(gene = input.gene.list,
                    OrgDb = org.Hs.eg.db,
                    # universe = rownames(tmp.full.list),
                    ont = "ALL",
                    pvalueCutoff = 0.05,
                    qvalueCutoff = 0.05,
                    readable = TRUE,
                    keyType = "SYMBOL",
                    pAdjustMethod = "BH")

  ora.GO.sum.res <- as.data.frame(ora.GO) 
} else {
  ora.GO.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

ora.GO.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

#### All LV samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "all_LV_samples"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]]
input.gene.list <- subset(tmp.full.list, tmp.full.list$p_val_adj <= 0.05)$Gene

if (length(input.gene.list != 0)){
  ora.GO <- enrichGO(gene = input.gene.list,
                    OrgDb = org.Hs.eg.db,
                    # universe = rownames(tmp.full.list),
                    ont = "ALL",
                    pvalueCutoff = 0.05,
                    qvalueCutoff = 0.05,
                    readable = TRUE,
                    keyType = "SYMBOL",
                    pAdjustMethod = "BH")

  ora.GO.sum.res <- as.data.frame(ora.GO) 
} else {
  ora.GO.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

ora.GO.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

#### All PV samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "all_PV_samples"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]]
input.gene.list <- subset(tmp.full.list, tmp.full.list$p_val_adj <= 0.05)$Gene

if (length(input.gene.list != 0)){
  ora.GO <- enrichGO(gene = input.gene.list,
                    OrgDb = org.Hs.eg.db,
                    # universe = rownames(tmp.full.list),
                    ont = "ALL",
                    pvalueCutoff = 0.05,
                    qvalueCutoff = 0.05,
                    readable = TRUE,
                    keyType = "SYMBOL",
                    pAdjustMethod = "BH")

  ora.GO.sum.res <- as.data.frame(ora.GO) 
} else {
  ora.GO.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

ora.GO.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

#### LV20
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "LV20"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]]
input.gene.list <- subset(tmp.full.list, tmp.full.list$p_val_adj <= 0.05)$Gene

if (length(input.gene.list != 0)){
  ora.GO <- enrichGO(gene = input.gene.list,
                    OrgDb = org.Hs.eg.db,
                    # universe = rownames(tmp.full.list),
                    ont = "ALL",
                    pvalueCutoff = 0.05,
                    qvalueCutoff = 0.05,
                    readable = TRUE,
                    keyType = "SYMBOL",
                    pAdjustMethod = "BH")

  ora.GO.sum.res <- as.data.frame(ora.GO) 
} else {
  ora.GO.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

ora.GO.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

#### LV21
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "LV21"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]]
input.gene.list <- subset(tmp.full.list, tmp.full.list$p_val_adj <= 0.05)$Gene

if (length(input.gene.list != 0)){
  ora.GO <- enrichGO(gene = input.gene.list,
                    OrgDb = org.Hs.eg.db,
                    # universe = rownames(tmp.full.list),
                    ont = "ALL",
                    pvalueCutoff = 0.05,
                    qvalueCutoff = 0.05,
                    readable = TRUE,
                    keyType = "SYMBOL",
                    pAdjustMethod = "BH")

  ora.GO.sum.res <- as.data.frame(ora.GO) 
} else {
  ora.GO.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

ora.GO.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

#### PV20
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "PV20"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]]
input.gene.list <- subset(tmp.full.list, tmp.full.list$p_val_adj <= 0.05)$Gene

if (length(input.gene.list != 0)){
  ora.GO <- enrichGO(gene = input.gene.list,
                    OrgDb = org.Hs.eg.db,
                    # universe = rownames(tmp.full.list),
                    ont = "ALL",
                    pvalueCutoff = 0.05,
                    qvalueCutoff = 0.05,
                    readable = TRUE,
                    keyType = "SYMBOL",
                    pAdjustMethod = "BH")

  ora.GO.sum.res <- as.data.frame(ora.GO) 
} else {
  ora.GO.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

ora.GO.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

#### PV21
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "PV21"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]]
input.gene.list <- subset(tmp.full.list, tmp.full.list$p_val_adj <= 0.05)$Gene

if (length(input.gene.list != 0)){
  ora.GO <- enrichGO(gene = input.gene.list,
                    OrgDb = org.Hs.eg.db,
                    # universe = rownames(tmp.full.list),
                    ont = "ALL",
                    pvalueCutoff = 0.05,
                    qvalueCutoff = 0.05,
                    readable = TRUE,
                    keyType = "SYMBOL",
                    pAdjustMethod = "BH")

  ora.GO.sum.res <- as.data.frame(ora.GO) 
} else {
  ora.GO.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

ora.GO.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

## KEGG-ORA 

### Summary tables {.tabset}

#### All LV and all PV samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "all_LV_and_all_PV"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]]
input.gene.list <- subset(tmp.full.list, tmp.full.list$p_val_adj <= 0.05)$Gene 

input.gene.list <- bitr(input.gene.list, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

if (length(input.gene.list != 0)){
  ora.KEGG <-  enrichKEGG(gene = input.gene.list$ENTREZID,
                 organism     = 'hsa',
                 pvalueCutoff = 0.05, 
                 qvalueCutoff = 0.05)

  ora.KEGG.sum.res <- as.data.frame(ora.KEGG) %>%
    rowwise() %>%
    mutate(geneSymbol = paste(to_vec(for (item in str_split(geneID, "/")[[1]]) subset(input.gene.list, input.gene.list$ENTREZID == item)$SYMBOL), collapse = ", "))
} else {
  ora.KEGG.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

ora.KEGG.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

#### All LV samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "all_LV_samples"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]]
input.gene.list <- subset(tmp.full.list, tmp.full.list$p_val_adj <= 0.05)$Gene 

input.gene.list <- bitr(input.gene.list, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

if (length(input.gene.list != 0)){
  ora.KEGG <-  enrichKEGG(gene = input.gene.list$ENTREZID,
                 organism     = 'hsa',
                 pvalueCutoff = 0.05, 
                 qvalueCutoff = 0.05)

  ora.KEGG.sum.res <- as.data.frame(ora.KEGG) %>%
    rowwise() %>%
    mutate(geneSymbol = paste(to_vec(for (item in str_split(geneID, "/")[[1]]) subset(input.gene.list, input.gene.list$ENTREZID == item)$SYMBOL), collapse = ", "))
} else {
  ora.KEGG.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

ora.KEGG.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

#### All PV and all PV samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "all_PV_samples"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]]
input.gene.list <- subset(tmp.full.list, tmp.full.list$p_val_adj <= 0.05)$Gene 

input.gene.list <- bitr(input.gene.list, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

if (length(input.gene.list != 0)){
  ora.KEGG <-  enrichKEGG(gene = input.gene.list$ENTREZID,
                 organism     = 'hsa',
                 pvalueCutoff = 0.05, 
                 qvalueCutoff = 0.05)

  ora.KEGG.sum.res <- as.data.frame(ora.KEGG) %>%
    rowwise() %>%
    mutate(geneSymbol = paste(to_vec(for (item in str_split(geneID, "/")[[1]]) subset(input.gene.list, input.gene.list$ENTREZID == item)$SYMBOL), collapse = ", "))
} else {
  ora.KEGG.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

ora.KEGG.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

#### LV20
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "LV20"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]]
input.gene.list <- subset(tmp.full.list, tmp.full.list$p_val_adj <= 0.05)$Gene 

input.gene.list <- bitr(input.gene.list, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

if (length(input.gene.list != 0)){
  ora.KEGG <-  enrichKEGG(gene = input.gene.list$ENTREZID,
                 organism     = 'hsa',
                 pvalueCutoff = 0.05, 
                 qvalueCutoff = 0.05)

  ora.KEGG.sum.res <- as.data.frame(ora.KEGG) %>%
    rowwise() %>%
    mutate(geneSymbol = paste(to_vec(for (item in str_split(geneID, "/")[[1]]) subset(input.gene.list, input.gene.list$ENTREZID == item)$SYMBOL), collapse = ", "))
} else {
  ora.KEGG.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

ora.KEGG.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

#### LV21
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "LV21"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]]
input.gene.list <- subset(tmp.full.list, tmp.full.list$p_val_adj <= 0.05)$Gene 

input.gene.list <- bitr(input.gene.list, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

if (length(input.gene.list != 0)){
  ora.KEGG <-  enrichKEGG(gene = input.gene.list$ENTREZID,
                 organism     = 'hsa',
                 pvalueCutoff = 0.05, 
                 qvalueCutoff = 0.05)

  ora.KEGG.sum.res <- as.data.frame(ora.KEGG) %>%
    rowwise() %>%
    mutate(geneSymbol = paste(to_vec(for (item in str_split(geneID, "/")[[1]]) subset(input.gene.list, input.gene.list$ENTREZID == item)$SYMBOL), collapse = ", "))
} else {
  ora.KEGG.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

ora.KEGG.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

#### PV20
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "PV20"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]]
input.gene.list <- subset(tmp.full.list, tmp.full.list$p_val_adj <= 0.05)$Gene 

input.gene.list <- bitr(input.gene.list, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

if (length(input.gene.list != 0)){
  ora.KEGG <-  enrichKEGG(gene = input.gene.list$ENTREZID,
                 organism     = 'hsa',
                 pvalueCutoff = 0.05, 
                 qvalueCutoff = 0.05)

  ora.KEGG.sum.res <- as.data.frame(ora.KEGG) %>%
    rowwise() %>%
    mutate(geneSymbol = paste(to_vec(for (item in str_split(geneID, "/")[[1]]) subset(input.gene.list, input.gene.list$ENTREZID == item)$SYMBOL), collapse = ", "))
} else {
  ora.KEGG.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

ora.KEGG.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

#### PV21
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "PV21"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]]
input.gene.list <- subset(tmp.full.list, tmp.full.list$p_val_adj <= 0.05)$Gene 

input.gene.list <- bitr(input.gene.list, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

if (length(input.gene.list != 0)){
  ora.KEGG <-  enrichKEGG(gene = input.gene.list$ENTREZID,
                 organism     = 'hsa',
                 pvalueCutoff = 0.05, 
                 qvalueCutoff = 0.05)

  ora.KEGG.sum.res <- as.data.frame(ora.KEGG) %>%
    rowwise() %>%
    mutate(geneSymbol = paste(to_vec(for (item in str_split(geneID, "/")[[1]]) subset(input.gene.list, input.gene.list$ENTREZID == item)$SYMBOL), collapse = ", "))
} else {
  ora.KEGG.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

ora.KEGG.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
```

## GO-GSEA 
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
go.gsea <- hash()
all.GSEA.GO.objects <- hash()
```

### Summary tables {.tabset}

#### All LV and all PV samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "all_LV_and_all_PV"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]] %>% arrange(desc(avg_log2FC))
input.gene.list <- tmp.full.list$avg_log2FC
names(input.gene.list) <- tmp.full.list$Gene

if (length(input.gene.list != 0)){
  GSEA.GO <- gseGO(geneList = input.gene.list,
              OrgD = org.Hs.eg.db,
              ont = "ALL",
              minGSSize = 100,
              maxGSSize = 500,
              pvalueCutoff = 0.05,
              verbose = TRUE,
              keyType = "SYMBOL", seed = TRUE)
  all.GSEA.GO.objects[[compare.case]] <- GSEA.GO
  GSEA.GO.sum.res <- as.data.frame(GSEA.GO) 
} else {
  GSEA.GO.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

GSEA.GO.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
go.gsea[[compare.case]] <- GSEA.GO.sum.res  
```

#### All LV  samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "all_LV_samples"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]] %>% arrange(desc(avg_log2FC))
input.gene.list <- tmp.full.list$avg_log2FC
names(input.gene.list) <- tmp.full.list$Gene

if (length(input.gene.list != 0)){
  GSEA.GO <- gseGO(geneList = input.gene.list,
              OrgD = org.Hs.eg.db,
              ont = "ALL",
              minGSSize = 100,
              maxGSSize = 500,
              pvalueCutoff = 0.05,
              verbose = TRUE,
              keyType = "SYMBOL", seed = TRUE)
  all.GSEA.GO.objects[[compare.case]] <- GSEA.GO
  GSEA.GO.sum.res <- as.data.frame(GSEA.GO) 
} else {
  GSEA.GO.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

GSEA.GO.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
go.gsea[[compare.case]] <- GSEA.GO.sum.res  
```

#### All PV samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "all_PV_samples"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]] %>% arrange(desc(avg_log2FC))
input.gene.list <- tmp.full.list$avg_log2FC
names(input.gene.list) <- tmp.full.list$Gene

if (length(input.gene.list != 0)){
  GSEA.GO <- gseGO(geneList = input.gene.list,
              OrgD = org.Hs.eg.db,
              ont = "ALL",
              minGSSize = 100,
              maxGSSize = 500,
              pvalueCutoff = 0.05,
              verbose = TRUE,
              keyType = "SYMBOL", seed = TRUE)
  all.GSEA.GO.objects[[compare.case]] <- GSEA.GO
  GSEA.GO.sum.res <- as.data.frame(GSEA.GO) 
} else {
  GSEA.GO.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

GSEA.GO.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
go.gsea[[compare.case]] <- GSEA.GO.sum.res  
```

#### LV20
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "LV20"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]] %>% arrange(desc(avg_log2FC))
input.gene.list <- tmp.full.list$avg_log2FC
names(input.gene.list) <- tmp.full.list$Gene

if (length(input.gene.list != 0)){
  GSEA.GO <- gseGO(geneList = input.gene.list,
              OrgD = org.Hs.eg.db,
              ont = "ALL",
              minGSSize = 100,
              maxGSSize = 500,
              pvalueCutoff = 0.05,
              verbose = TRUE,
              keyType = "SYMBOL", seed = TRUE)
  all.GSEA.GO.objects[[compare.case]] <- GSEA.GO
  GSEA.GO.sum.res <- as.data.frame(GSEA.GO) 
} else {
  GSEA.GO.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

GSEA.GO.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
go.gsea[[compare.case]] <- GSEA.GO.sum.res  
```

#### LV21
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "LV21"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]] %>% arrange(desc(avg_log2FC))
input.gene.list <- tmp.full.list$avg_log2FC
names(input.gene.list) <- tmp.full.list$Gene

if (length(input.gene.list != 0)){
  GSEA.GO <- gseGO(geneList = input.gene.list,
              OrgD = org.Hs.eg.db,
              ont = "ALL",
              minGSSize = 100,
              maxGSSize = 500,
              pvalueCutoff = 0.05,
              verbose = TRUE,
              keyType = "SYMBOL", seed = TRUE)
  all.GSEA.GO.objects[[compare.case]] <- GSEA.GO
  GSEA.GO.sum.res <- as.data.frame(GSEA.GO) 
} else {
  GSEA.GO.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

GSEA.GO.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
go.gsea[[compare.case]] <- GSEA.GO.sum.res  
```

#### PV20
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "PV20"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]] %>% arrange(desc(avg_log2FC))
input.gene.list <- tmp.full.list$avg_log2FC
names(input.gene.list) <- tmp.full.list$Gene

if (length(input.gene.list != 0)){
  GSEA.GO <- gseGO(geneList = input.gene.list,
              OrgD = org.Hs.eg.db,
              ont = "ALL",
              minGSSize = 100,
              maxGSSize = 500,
              pvalueCutoff = 0.05,
              verbose = TRUE,
              keyType = "SYMBOL", seed = TRUE)
  all.GSEA.GO.objects[[compare.case]] <- GSEA.GO
  GSEA.GO.sum.res <- as.data.frame(GSEA.GO) 
} else {
  GSEA.GO.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

GSEA.GO.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
go.gsea[[compare.case]] <- GSEA.GO.sum.res  
```

#### PV21
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "PV21"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]] %>% arrange(desc(avg_log2FC))
input.gene.list <- tmp.full.list$avg_log2FC
names(input.gene.list) <- tmp.full.list$Gene

if (length(input.gene.list != 0)){
  GSEA.GO <- gseGO(geneList = input.gene.list,
              OrgD = org.Hs.eg.db,
              ont = "ALL",
              minGSSize = 100,
              maxGSSize = 500,
              pvalueCutoff = 0.05,
              verbose = TRUE,
              keyType = "SYMBOL", seed = TRUE)
  all.GSEA.GO.objects[[compare.case]] <- GSEA.GO
  GSEA.GO.sum.res <- as.data.frame(GSEA.GO) 
} else {
  GSEA.GO.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

GSEA.GO.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
go.gsea[[compare.case]] <- GSEA.GO.sum.res  
```

### Summary plots {.tabset}
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
for (compare.case in names(compare_DC1_DC2_raw)){
  if (nrow(go.gsea[[compare.case]] != 0)){
    cat(sprintf("#### %s \n", compare.case))
    plot.df <- go.gsea[[compare.case]] %>% subset(select = c(Description, NES)) %>% arrange(desc(NES))
    p <- ggplot(data = plot.df, aes(y = reorder(Description, NES), x = NES)) + geom_bar(stat = "identity")    
    print(p)
    cat("\n \n")
  }
}

```



## KEGG-GSEA
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
kegg.gsea <- hash()
all.GSEA.KEGG.objects <- hash()
```

### Summary tables {.tabset}

#### All LV and all PV samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "all_LV_and_all_PV"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]] %>% arrange(desc(avg_log2FC))
convertdf <- bitr(tmp.full.list$Gene, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
input.gene.list <- tmp.full.list$avg_log2FC
names(input.gene.list) <- convertdf$ENTREZID

if (length(input.gene.list != 0)){
  GSEA.KEGG <- gseKEGG(geneList = input.gene.list,
              organism = "hsa",
              minGSSize = 100,
              maxGSSize = 500,
              pvalueCutoff = 0.05,
              verbose = FALSE, seed = TRUE)
  all.GSEA.KEGG.objects[[compare.case]] <- GSEA.KEGG
  GSEA.KEGG.sum.res <- as.data.frame(GSEA.KEGG)
  if (nrow(GSEA.KEGG.sum.res) != 0){
    GSEA.KEGG.sum.res <- GSEA.KEGG.sum.res %>%
    rowwise() %>%
    mutate(core_enrichment = paste(to_vec(for (item in str_split(core_enrichment, "/")[[1]]) subset(convertdf, convertdf$ENTREZID == item)$SYMBOL), collapse = ", "))
  } else {
    GSEA.KEGG.sum.res <- data.frame(data = c("No enriched pathway found"))
  }
  
} else {
  GSEA.KEGG.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

GSEA.KEGG.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
kegg.gsea[[compare.case]] <- GSEA.KEGG.sum.res
```

#### All LV samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "all_LV_samples"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]] %>% arrange(desc(avg_log2FC))
convertdf <- bitr(tmp.full.list$Gene, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
input.gene.list <- tmp.full.list$avg_log2FC
names(input.gene.list) <- convertdf$ENTREZID

if (length(input.gene.list != 0)){
  GSEA.KEGG <- gseKEGG(geneList = input.gene.list,
              organism = "hsa",
              minGSSize = 100,
              maxGSSize = 500,
              pvalueCutoff = 0.05,
              verbose = FALSE, seed = TRUE)
  all.GSEA.KEGG.objects[[compare.case]] <- GSEA.KEGG
  GSEA.KEGG.sum.res <- as.data.frame(GSEA.KEGG)
  if (nrow(GSEA.KEGG.sum.res) != 0){
    GSEA.KEGG.sum.res <- GSEA.KEGG.sum.res %>%
    rowwise() %>%
    mutate(core_enrichment = paste(to_vec(for (item in str_split(core_enrichment, "/")[[1]]) subset(convertdf, convertdf$ENTREZID == item)$SYMBOL), collapse = ", "))
  } else {
    GSEA.KEGG.sum.res <- data.frame(data = c("No enriched pathway found"))
  }
  
} else {
  GSEA.KEGG.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

GSEA.KEGG.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
kegg.gsea[[compare.case]] <- GSEA.KEGG.sum.res
```

#### All PV samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "all_PV_samples"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]] %>% arrange(desc(avg_log2FC))
convertdf <- bitr(tmp.full.list$Gene, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
input.gene.list <- tmp.full.list$avg_log2FC
names(input.gene.list) <- convertdf$ENTREZID

if (length(input.gene.list != 0)){
  GSEA.KEGG <- gseKEGG(geneList = input.gene.list,
              organism = "hsa",
              minGSSize = 100,
              maxGSSize = 500,
              pvalueCutoff = 0.05,
              verbose = FALSE, seed = TRUE)
  all.GSEA.KEGG.objects[[compare.case]] <- GSEA.KEGG
  GSEA.KEGG.sum.res <- as.data.frame(GSEA.KEGG)
  if (nrow(GSEA.KEGG.sum.res) != 0){
    GSEA.KEGG.sum.res <- GSEA.KEGG.sum.res %>%
    rowwise() %>%
    mutate(core_enrichment = paste(to_vec(for (item in str_split(core_enrichment, "/")[[1]]) subset(convertdf, convertdf$ENTREZID == item)$SYMBOL), collapse = ", "))
  } else {
    GSEA.KEGG.sum.res <- data.frame(data = c("No enriched pathway found"))
  }
  
} else {
  GSEA.KEGG.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

GSEA.KEGG.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
kegg.gsea[[compare.case]] <- GSEA.KEGG.sum.res
```

#### LV20
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "LV20"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]] %>% arrange(desc(avg_log2FC))
convertdf <- bitr(tmp.full.list$Gene, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
input.gene.list <- tmp.full.list$avg_log2FC
names(input.gene.list) <- convertdf$ENTREZID

if (length(input.gene.list != 0)){
  GSEA.KEGG <- gseKEGG(geneList = input.gene.list,
              organism = "hsa",
              minGSSize = 100,
              maxGSSize = 500,
              pvalueCutoff = 0.05,
              verbose = FALSE, seed = TRUE)
  all.GSEA.KEGG.objects[[compare.case]] <- GSEA.KEGG
  GSEA.KEGG.sum.res <- as.data.frame(GSEA.KEGG)
  if (nrow(GSEA.KEGG.sum.res) != 0){
    GSEA.KEGG.sum.res <- GSEA.KEGG.sum.res %>%
    rowwise() %>%
    mutate(core_enrichment = paste(to_vec(for (item in str_split(core_enrichment, "/")[[1]]) subset(convertdf, convertdf$ENTREZID == item)$SYMBOL), collapse = ", "))
  } else {
    GSEA.KEGG.sum.res <- data.frame(data = c("No enriched pathway found"))
  }
  
} else {
  GSEA.KEGG.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

GSEA.KEGG.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
kegg.gsea[[compare.case]] <- GSEA.KEGG.sum.res
```

#### LV21
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "LV21"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]] %>% arrange(desc(avg_log2FC))
convertdf <- bitr(tmp.full.list$Gene, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
input.gene.list <- tmp.full.list$avg_log2FC
names(input.gene.list) <- convertdf$ENTREZID

if (length(input.gene.list != 0)){
  GSEA.KEGG <- gseKEGG(geneList = input.gene.list,
              organism = "hsa",
              minGSSize = 100,
              maxGSSize = 500,
              pvalueCutoff = 0.05,
              verbose = FALSE, seed = TRUE)
  all.GSEA.KEGG.objects[[compare.case]] <- GSEA.KEGG
  GSEA.KEGG.sum.res <- as.data.frame(GSEA.KEGG)
  if (nrow(GSEA.KEGG.sum.res) != 0){
    GSEA.KEGG.sum.res <- GSEA.KEGG.sum.res %>%
    rowwise() %>%
    mutate(core_enrichment = paste(to_vec(for (item in str_split(core_enrichment, "/")[[1]]) subset(convertdf, convertdf$ENTREZID == item)$SYMBOL), collapse = ", "))
  } else {
    GSEA.KEGG.sum.res <- data.frame(data = c("No enriched pathway found"))
  }
  
} else {
  GSEA.KEGG.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

GSEA.KEGG.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
kegg.gsea[[compare.case]] <- GSEA.KEGG.sum.res
```

#### PV20
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "PV20"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]] %>% arrange(desc(avg_log2FC))
convertdf <- bitr(tmp.full.list$Gene, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
input.gene.list <- tmp.full.list$avg_log2FC
names(input.gene.list) <- convertdf$ENTREZID

if (length(input.gene.list != 0)){
  GSEA.KEGG <- gseKEGG(geneList = input.gene.list,
              organism = "hsa",
              minGSSize = 100,
              maxGSSize = 500,
              pvalueCutoff = 0.05,
              verbose = FALSE, seed = TRUE)
  all.GSEA.KEGG.objects[[compare.case]] <- GSEA.KEGG
  GSEA.KEGG.sum.res <- as.data.frame(GSEA.KEGG)
  if (nrow(GSEA.KEGG.sum.res) != 0){
    GSEA.KEGG.sum.res <- GSEA.KEGG.sum.res %>%
    rowwise() %>%
    mutate(core_enrichment = paste(to_vec(for (item in str_split(core_enrichment, "/")[[1]]) subset(convertdf, convertdf$ENTREZID == item)$SYMBOL), collapse = ", "))
  } else {
    GSEA.KEGG.sum.res <- data.frame(data = c("No enriched pathway found"))
  }
  
} else {
  GSEA.KEGG.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

GSEA.KEGG.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
kegg.gsea[[compare.case]] <- GSEA.KEGG.sum.res
```

#### PV21
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
compare.case <- "PV21"

tmp.full.list <- compare_DC1_DC2_raw[[compare.case]] %>% arrange(desc(avg_log2FC))
convertdf <- bitr(tmp.full.list$Gene, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
input.gene.list <- tmp.full.list$avg_log2FC
names(input.gene.list) <- convertdf$ENTREZID

if (length(input.gene.list != 0)){
  GSEA.KEGG <- gseKEGG(geneList = input.gene.list,
              organism = "hsa",
              minGSSize = 100,
              maxGSSize = 500,
              pvalueCutoff = 0.05,
              verbose = FALSE, seed = TRUE)
  all.GSEA.KEGG.objects[[compare.case]] <- GSEA.KEGG
  GSEA.KEGG.sum.res <- as.data.frame(GSEA.KEGG)
  if (nrow(GSEA.KEGG.sum.res) != 0){
    GSEA.KEGG.sum.res <- GSEA.KEGG.sum.res %>%
    rowwise() %>%
    mutate(core_enrichment = paste(to_vec(for (item in str_split(core_enrichment, "/")[[1]]) subset(convertdf, convertdf$ENTREZID == item)$SYMBOL), collapse = ", "))
  } else {
    GSEA.KEGG.sum.res <- data.frame(data = c("No enriched pathway found"))
  }
  
} else {
  GSEA.KEGG.sum.res <- data.frame(data = c("No DE genes to conduct ORA"))
}

GSEA.KEGG.sum.res %>% mutate_if(is.numeric, round, 6) %>% create_dt()
kegg.gsea[[compare.case]] <- GSEA.KEGG.sum.res
```

### Summary plots {.tabset}
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
for (compare.case in names(compare_DC1_DC2_raw)){
  if ("data" %in% colnames(kegg.gsea[[compare.case]]) == FALSE){
    cat(sprintf("#### %s \n", compare.case))
    plot.df <- kegg.gsea[[compare.case]] %>% subset(select = c(Description, NES)) %>% arrange(desc(NES))
    p <- ggplot(data = plot.df, aes(y = reorder(Description, NES), x = NES)) + geom_bar(stat = "identity")    
    print(p)
    cat("\n \n")
  }
}
```


```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
#####----------------------------------------------------------------------#####
##### SAVE ENRICHMENT PLOTS TO FILES 
#####----------------------------------------------------------------------#####

for (case in names(all.GSEA.GO.objects)){
  if (dim(all.GSEA.GO.objects[[case]])[[1]] != 0 ){
  path.to.save.enrichmentplot <- file.path(path.to.02.output, "enrichment_plots", "GSEA_GO", case)
  dir.create(path.to.save.enrichmentplot, showWarnings = FALSE)
  tmp <- all.GSEA.GO.objects[[case]] 
  for (i in seq(nrow(tmp))){
    savename <- sprintf("[%s]_%s.png", case, tmp$Description[i])
    p <- gseaplot(tmp, geneSetID = i, title = sprintf("Pathway: %s, \n NES = %s", tmp$Description[i], round(tmp$NES[i], 3)))
    ggsave(plot = p, device = "png", dpi = 300, path = file.path(path.to.save.enrichmentplot), filename = savename)
  }}
}
  
for (case in names(all.GSEA.KEGG.objects)){
  if (dim(all.GSEA.KEGG.objects[[case]])[[1]] != 0 ){
  path.to.save.enrichmentplot <- file.path(path.to.02.output, "enrichment_plots", "GSEA_KEGG", case)
  dir.create(path.to.save.enrichmentplot, showWarnings = FALSE)
  tmp <- all.GSEA.KEGG.objects[[case]] 
  for (i in seq(nrow(tmp))){
    savename <- sprintf("[%s]_%s.png", case, tmp$Description[i])
    p <- gseaplot(tmp, geneSetID = i, title = sprintf("Pathway: %s, \n NES = %s", tmp$Description[i], round(tmp$NES[i], 3)))
    ggsave(plot = p, device = "png", dpi = 300, path = file.path(path.to.save.enrichmentplot), filename = savename)
  }
  }
}
  
```
